<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Alunos - Sistema Crescer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/loader.css">
    <script src="js/loader.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .btn-primary {
            background-color: #4f46e5;
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-edit {
            background-color: #22c55e;
            color: #ffffff;
        }

        .btn-edit:hover {
            background-color: #16a34a;
        }

        .btn-delete {
            background-color: #ef4444;
            color: #ffffff;
        }

        .btn-delete:hover {
            background-color: #dc2626;
        }

        .btn-info {
            background-color: #3b82f6;
            color: #ffffff;
        }

        .btn-info:hover {
            background-color: #2563eb;
        }

        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .message.success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .message.error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .modal {
            display: none;
            /* AQUI ESTAVA O ERRO - A SEGUNDA LINHA "display: flex" FOI REMOVIDA */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .search-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: flex-end;
        }

        .search-group input {
            flex-grow: 1;
        }

        .search-group button {
            flex-shrink: 0;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        


    </style>
</head>

<body>
    <nav class="bg-gray-800 p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center max-w-full px-4">
            <a href="#" class="text-black text-2xl font-bold">Sistema Crescer</a>
            <div>
                <a href="crud_alunos.html"
                    class="bg-gray-900 text-white px-3 py-2 rounded-md text-base font-medium">Alunos</a>
                <a href="crud_turmas.html"
                    class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md">Turmas</a>
                <a href="crud_professores.html"
                    class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md">Professores</a>
                <a href="crud_disciplinas.html"
                    class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md">Disciplinas</a>
                <a href="crud_mensalidades.html"
                    class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md">Mensalidades</a>
                <a href="crud_consultar_cpf.html"
                    class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md">Consulta CPF</a>
                <button onclick="logout()"
                    class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Gerenciamento de Alunos</h1>
        <div id="message-area" class="message hidden"></div>
        <div class="flex justify-between items-center mb-4">
            <button class="btn btn-primary" onclick="openAddModal()">Cadastrar Novo Aluno</button>
        </div>

        <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Buscar Alunos</h2>
            <div class="search-group">
                <div class="form-group mb-0">
                    <label for="search_name">Buscar por Nome</label>
                    <input type="text" id="search_name" name="search_name" placeholder="Digite o nome do aluno">
                </div>
                <div class="form-group mb-0">
                    <label for="search_ra">Buscar por RA</label>
                    <input type="text" id="search_ra" name="search_ra" placeholder="Digite o RA do aluno">
                </div>
                <button class="btn btn-primary btn-small" onclick="fetchAlunos()">Buscar</button>
                <button class="btn btn-secondary btn-small" onclick="clearSearch()">Limpar Busca</button>
            </div>
        </div>


        <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Alunos Cadastrados</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Nome</th>
                            <th class="px-4 py-2 text-left">RA</th>
                            <th class="px-4 py-2 text-left">Turma</th>
                            <th class="px-4 py-2 text-left">Responsável</th>
                            <th class="px-4 py-2 text-left">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="alunos-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="alunoModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modal-title" class="text-2xl font-semibold text-gray-700 mb-4"></h2>
            <div id="modal-message-area" class="message hidden"></div>
            <form id="aluno-form" class="max-h-[70vh] overflow-y-auto p-2">
                <input type="hidden" id="id_aluno">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-3">
                        <h3 class="text-lg font-semibold border-b pb-1">Dados do Aluno</h3>
                    </div>
                    <div class="form-group"><label for="nome_aluno">Nome Completo <span
                                class="text-red-500">*</span></label><input type="text" id="nome_aluno"
                            name="nome_aluno" required></div>
                    <div class="form-group"><label for="ra">RA <span class="text-red-500">*</span></label><input
                            type="text" id="ra" name="ra" required></div>
                    <div class="form-group"><label for="data_nascimento">Data de Nascimento</label><input type="date"
                            id="data_nascimento" name="data_nascimento"></div>
                    <div class="form-group"><label for="rg_aluno">RG do Aluno</label><input type="text" id="rg_aluno"
                            name="rg_aluno"></div>
                    <div class="form-group"><label for="cpf_aluno">CPF do Aluno</label><input type="text" id="cpf_aluno"
                            name="cpf_aluno"></div>
                    <div class="form-group"><label for="idade">Idade</label><input type="number" id="idade" name="idade"
                            readonly class="bg-gray-200"></div>
                    <div class="form-group"><label for="id_turma">Turma</label><select id="id_turma" name="id_turma">
                            <option value="">Selecione</option>
                        </select></div>
                    <div class="form-group"><label for="periodo">Período</label><select id="periodo" name="periodo">
                            <option value="">Selecione</option>
                            <option>Manhã</option>
                            <option>Tarde</option>
                            <option>Noite</option>
                        </select></div>

                    <div class="form-group">
                        <label for="data_inicio">Data de Início das Aulas</label>
                        <input type="date" id="data_inicio" name="data_inicio" required>
                    </div>

                    <div class="md:col-span-3 mt-4">
                        <h3 class="text-lg font-semibold border-b pb-1">Endereço</h3>
                    </div>
                    <div class="form-group"><label for="cep">CEP</label><input type="text" id="cep" name="cep"
                            maxlength="9"></div>
                    <div class="form-group md:col-span-2"><label for="endereco">Endereço</label><input type="text"
                            id="endereco" name="endereco"></div>
                    <div class="form-group"><label for="complemento">Complemento</label><input type="text"
                            id="complemento" name="complemento"></div>
                    <div class="form-group"><label for="bairro">Bairro</label><input type="text" id="bairro"
                            name="bairro"></div>
                    <div class="form-group"><label for="cidade">Cidade</label><input type="text" id="cidade"
                            name="cidade"></div>
                    <div class="form-group"><label for="estado">Estado (UF)</label><input type="text" id="estado"
                            name="estado" maxlength="2"></div>

                    <div class="md:col-span-3 mt-4">
                        <h3 class="text-lg font-semibold border-b pb-1">Responsável Financeiro</h3>
                    </div>
                    <div class="form-group"><label for="responsavel">Nome</label><input type="text" id="responsavel"
                            name="responsavel"></div>
                    <div class="form-group"><label for="cpf_responsavel">CPF</label><input type="text"
                            id="cpf_responsavel" name="cpf_responsavel"></div>
                    <div class="form-group"><label for="celular_responsavel">Celular</label><input type="text"
                            id="celular_responsavel" name="celular_responsavel"></div>
                    <div class="form-group"><label for="telefone_responsavel">Telefone</label><input type="text"
                            id="telefone_responsavel" name="telefone_responsavel"></div>
                    <div class="form-group md:col-span-2"><label for="email_responsavel">Email</label><input
                            type="email" id="email_responsavel" name="email_responsavel"></div>

                    <div class="md:col-span-3 mt-4">
                        <p class="text-sm text-gray-600">É obrigatório preencher os dados completos (Nome e CPF) do Pai
                            <span class="font-bold">OU</span> da Mãe.
                        </p>
                    </div>
                    <div class="md:col-span-3">
                        <h3 class="text-lg font-semibold border-b pb-1">Dados do Pai</h3>
                    </div>
                    <div class="form-group"><label for="nome_pai">Nome do Pai</label><input type="text" id="nome_pai"
                            name="nome_pai"></div>
                    <div class="form-group"><label for="cpf_pai">CPF do Pai</label><input type="text" id="cpf_pai"
                            name="cpf_pai"></div>

                    <div class="md:col-span-3">
                        <h3 class="text-lg font-semibold border-b pb-1">Dados da Mãe</h3>
                    </div>
                    <div class="form-group"><label for="nome_mae">Nome da Mãe</label><input type="text" id="nome_mae"
                            name="nome_mae"></div>
                    <div class="form-group"><label for="cpf_mae">CPF da Mãe</label><input type="text" id="cpf_mae"
                            name="cpf_mae"></div>

                    

                    <div class="md:col-span-3 mt-4">
                        <h3 class="text-lg font-semibold border-b pb-1">Financeiro (Geração de Mensalidades)</h3>
                    </div>
                    <div class="form-group">
                        <label for="valor_anuidade_total">Valor da Anuidade (Total do Ano)</label>
                        <input type="number" step="0.01" id="valor_anuidade_total" name="valor_anuidade_total"
                            placeholder="Custo total do ano letivo. Ex: 12400.00" required>
                    </div>
                    <div class="form-group">
                        <label for="valor_matricula">Valor da Matrícula (1ª Cobrança)</label>
                        <input type="number" step="0.01" id="valor_matricula" name="valor_matricula"
                            placeholder="Valor pago no ato. Ex: 1000.00" required>
                    </div>
                    <div class="form-group">
                        <label for="dia_vencimento_mensalidades">Dia de Vencimento das Parcelas</label>
                        <input type="number" id="dia_vencimento_mensalidades" name="dia_vencimento_mensalidades"
                            placeholder="Ex: 10" min="1" max="31" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                </div>


        </div>
        
    </div>
    </div>

    <div id="global-loader" class="loader-overlay">
        <div class="spinner"></div>
    </div>

    <script>


       


        const API_BASE_URL_ALUNOS = 'http://localhost/Sistema/api/alunos';
        const API_BASE_URL_TURMAS = 'http://localhost/Sistema/api/turmas';
        const API_LOGIN_URL = 'login.html';

        const alunoModal = document.getElementById('alunoModal');
        const alunoForm = document.getElementById('aluno-form');
        const modalTitle = document.getElementById('modal-title');
        const modalMessageArea = document.getElementById('modal-message-area');
        const messageArea = document.getElementById('message-area');
        const alunosTableBody = document.getElementById('alunos-table-body');

        const cleanNumber = (num) => num ? String(num).replace(/\D/g, '') : null;

        function displayMessage(message, type, area = messageArea) {
            area.textContent = message;
            area.className = `message ${type}`;
            area.classList.remove('hidden');
            setTimeout(() => area.classList.add('hidden'), 5000);
        }

        function openAddModal() {
            alunoForm.reset();
            document.getElementById('id_aluno').value = '';
            modalTitle.textContent = 'Cadastrar Novo Aluno';
            modalMessageArea.classList.add('hidden');
            alunoModal.style.display = 'flex';
        }

        async function openEditModal(id) {
            alunoForm.reset();
            modalTitle.textContent = 'Carregando dados para edição...';
            modalMessageArea.classList.add('hidden');
            alunoModal.style.display = 'flex';

            try {
                const response = await fetch(`${API_BASE_URL_ALUNOS}/${id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` }
                });
                if (!response.ok) throw new Error('Falha ao carregar dados do aluno.');
                const result = await response.json();

                if (result.success) {
                    const aluno = result.data;
                    modalTitle.textContent = `Editar Aluno (ID: ${aluno.id_aluno})`;
                    for (const key in aluno) {
                        const field = document.getElementById(key);
                        if (field) {
                            field.value = aluno[key] || '';
                        }
                    }
                } else {
                    displayMessage(result.message, 'error', modalMessageArea);
                }
            } catch (error) {
                displayMessage(error.message, 'error', modalMessageArea);
            }
        }

        function closeModal() {
            alunoModal.style.display = 'none';
        }

        document.getElementById('data_nascimento').addEventListener('change', (e) => {
            if (e.target.value) {
                const birthDate = new Date(e.target.value);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                document.getElementById('idade').value = age;
            } else {
                document.getElementById('idade').value = '';
            }
        });

        document.getElementById('cep').addEventListener('blur', async (e) => {
            const cep = cleanNumber(e.target.value);
            if (cep && cep.length === 8) {
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (!data.erro) {
                        document.getElementById('endereco').value = data.logradouro || '';
                        document.getElementById('bairro').value = data.bairro || '';
                        document.getElementById('cidade').value = data.localidade || '';
                        document.getElementById('estado').value = data.uf || '';
                    }
                } catch (error) { console.error("Erro ao buscar CEP:", error); }
            }
        });

        alunoForm.addEventListener('submit', async (e) => {
            e.preventDefault();

             // --- LÓGICA DO LOADER DE BOTÃO ---
            const submitButton = alunoForm.querySelector('button[type="submit"]');
            const originalButtonContent = submitButton.innerHTML; // Salva o texto original
            
            // Ativa o estado de carregamento
            submitButton.disabled = true;
            submitButton.innerHTML = `<div class="btn-spinner"></div> Salvando...`;
            // --- FIM DA LÓGICA DO LOADER ---

            const id = document.getElementById('id_aluno').value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_BASE_URL_ALUNOS}/${id}` : API_BASE_URL_ALUNOS;

            const formData = new FormData(alunoForm);
            const alunoData = {};
            formData.forEach((value, key) => {
                alunoData[key] = value === '' ? null : value;
            });
            if (id) {
                alunoData.id_aluno = id;
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` },
                    body: JSON.stringify(alunoData)
                });
                const result = await response.json();
                if (result.success) {
                    displayMessage(result.message, 'success');
                    closeModal();
                    fetchAlunos();
                } else {
                    displayMessage(result.message, 'error', modalMessageArea);
                }
            } catch (error) {
                displayMessage('Erro de conexão ao salvar aluno. Verifique o console para mais detalhes.', 'error', modalMessageArea);
                console.error('Fetch error:', error);
            } finally {
                // --- RESTAURA O BOTÃO ---
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
                // --- FIM DA RESTAURAÇÃO ---
            }
        });

        async function fetchTurmas() {
            try {
                const response = await fetch(API_BASE_URL_TURMAS, { headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` } });
                if (!response.ok) return;
                const result = await response.json();
                if (result.success) {
                    const select = document.getElementById('id_turma');
                    select.innerHTML = '<option value="">Selecione a Turma</option>';
                    result.data.forEach(turma => {
                        select.innerHTML += `<option value="${turma.id_turma}">${turma.nome_turma}</option>`;
                    });
                }
            } catch (error) { console.error("Erro ao buscar turmas:", error); }
        }

        async function fetchAlunos() {
            showLoader();
            alunosTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Carregando...</td></tr>';
            const searchName = document.getElementById('search_name').value.trim();
            const searchRa = document.getElementById('search_ra').value.trim();
            let url = API_BASE_URL_ALUNOS;
            const params = new URLSearchParams();

            if (searchName) {
                params.append('nome', searchName);
            }
            if (searchRa) {
                params.append('ra', searchRa);
            }
            if (params.toString()) {
                url += '?' + params.toString();
            }

            // Obter a role do usuário do localStorage
            const userRole = localStorage.getItem('user_role'); //
            
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` } });
                if (!response.ok) throw new Error('Falha ao carregar alunos.');
                const result = await response.json();

                alunosTableBody.innerHTML = '';
                if (result.success && result.data.length > 0) {
                    result.data.forEach(aluno => {
                        // Construir os botões de ação dinamicamente
                        let actionButtons = `
                            <button class="btn btn-edit text-sm" onclick="openEditModal(${aluno.id_aluno})">Editar</button>
                            <button class="btn btn-delete text-sm ml-2" onclick="deleteAluno(${aluno.id_aluno})">Excluir</button>
                        `;

                        // Adicionar o botão "Ver Boletim" APENAS se o usuário NÃO FOR 'admin'
                        if (userRole !== 'admin') { //
                            actionButtons += `
                                <button class="btn btn-info text-sm ml-2" onclick="viewBoletim(${aluno.id_aluno}, '${encodeURIComponent(aluno.nome_aluno)}', '${aluno.ra}', '${encodeURIComponent(aluno.nome_turma || 'N/A')}')">Ver Boletim</button>
                            `;
                        }

                        const row = `
                            <tr>
                                <td class="px-4 py-2">${aluno.id_aluno}</td>
                                <td class="px-4 py-2 font-medium">${aluno.nome_aluno}</td>
                                <td class="px-4 py-2">${aluno.ra}</td>
                                <td class="px-4 py-2">${aluno.nome_turma || 'N/A'}</td>
                                <td class="px-4 py-2">${aluno.responsavel || 'N/A'}</td>
                                <td class="px-4 py-2 whitespace-nowrap">
                                    ${actionButtons}
                                </td>
                            </tr>
                        `;
                        alunosTableBody.innerHTML += row;
                    });
                } else {
                    alunosTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Nenhum aluno encontrado.</td></tr>';
                }
            } catch (error) { 
                displayMessage(error.message, 'error'); 
            } finally {
                hideLoader(); // ESCONDE o loader no final, ocorrendo erro ou nã
            }
        }

        function clearSearch() {
            document.getElementById('search_name').value = '';
            document.getElementById('search_ra').value = '';
            fetchAlunos();
        }

        window.deleteAluno = async (id) => {
            if (!confirm('Tem certeza que deseja excluir este aluno?')) return;
            try {
                const response = await fetch(`${API_BASE_URL_ALUNOS}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` }
                });
                const result = await response.json();
                displayMessage(result.message, result.success ? 'success' : 'error');
                if (result.success) fetchAlunos();
            } catch (error) { displayMessage('Erro de conexão ao excluir aluno.', 'error'); }
        };

        window.viewBoletim = (idAluno, nomeAluno, raAluno, turmaAluno) => {
            window.location.href = `boletim_aluno_view.html?idAluno=${idAluno}&nomeAluno=${nomeAluno}&raAluno=${raAluno}&turmaAluno=${turmaAluno}`;
        };


        function logout() {
            localStorage.clear();
            window.location.href = API_LOGIN_URL;
        }

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwt_token');
            const role = localStorage.getItem('user_role'); //
            if (!token || (role !== 'professor' && role !== 'admin' && role !== 'aluno')) { // Inclui 'aluno' para permitir acesso à página se a role for aluno
                window.location.href = API_LOGIN_URL;
                return;
            }
            fetchTurmas();
            fetchAlunos();
        });
    </script>
</body>

</html>