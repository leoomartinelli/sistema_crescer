<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD de Alunos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #374151;
            background-color: #f9fafb;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: #ffffff;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-edit {
            background-color: #22c55e;
            color: #ffffff;
        }
        .btn-edit:hover {
            background-color: #16a34a;
        }
        .btn-delete {
            background-color: #ef4444;
            color: #ffffff;
        }
        .btn-delete:hover {
            background-color: #dc2626;
        }
        .btn-copy {
            background-color: #0ea5e9;
            color: #ffffff;
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            margin-left: 0.5rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-copy:hover {
            background-color: #0284c7;
        }
        .message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .message.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .message.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .error-message { /* Estilo para mensagens de erro de campo */
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 700;
            color: #4b5563;
        }
        tr:hover {
            background-color: #f3f4f6;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%; /* Adjust width as needed */
            max-width: 800px; /* Max width for larger screens */
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal.hidden {
            display: none;
        }
        .modal.visible {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="bg-gray-800 p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-white text-2xl font-bold">Sistema Crescer</a>
            <div>
                <a href="crud_alunos.html" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-base font-medium">Alunos</a>
                <a href="crud_turmas.html" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-base font-medium">Turmas</a>
                <button onclick="logout()" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-base font-medium">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Gerenciamento de Alunos</h1>

        <div id="message-area" class="message hidden"></div>
        
        <!-- Botão para abrir o modal de cadastro de aluno -->
        <div class="flex justify-end mb-4">
            <button class="btn btn-primary" onclick="openAddAlunoModal()">Cadastrar Novo Aluno</button>
        </div>

        <!-- Lista de Alunos -->
        <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Alunos Cadastrados</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>RA</th>
                            <th>Idade</th>
                            <th>Turma</th>
                            <th>Período</th>
                            <th>Endereço</th>
                            <th>Complemento</th>
                            <th>Bairro</th>
                            <th>Cidade</th>
                            <th>Estado</th>
                            <th>CEP</th>
                            <th>Responsável</th>
                            <th>Telefone Responsável</th>
                            <th>Celular Responsável</th>
                            <th>Email Responsável</th>
                            <th>CPF Responsável</th>
                            <th>Nome Pai</th>
                            <th>CPF Pai</th>
                            <th>Nome Mãe</th>
                            <th>CPF Mãe</th>
                            <th>Login</th>
                            <th>Senha</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="alunos-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Dados dos alunos serão carregados aqui -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Adição de Aluno -->
    <div id="addAlunoModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeAddAlunoModal()">&times;</span>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Adicionar Novo Aluno</h2>
            <!-- Área de mensagem específica para o modal de adição -->
            <div id="add-message-area" class="message hidden"></div> 
            <form id="add-aluno-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label for="add_nome_aluno">Nome do Aluno <span class="text-red-500">*</span></label>
                    <input type="text" id="add_nome_aluno" name="nome_aluno" required class="rounded-md">
                    <span id="add_nome_aluno_error" class="error-message hidden"></span>
                </div>
                <div class="form-group">
                    <label for="add_ra">RA <span class="text-red-500">*</span></label>
                    <input type="text" id="add_ra" name="ra" required class="rounded-md">
                    <span id="add_ra_error" class="error-message hidden"></span>
                </div>
                <div class="form-group">
                    <label for="add_data_nascimento">Data de Nascimento</label>
                    <input type="date" id="add_data_nascimento" name="data_nascimento" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="add_idade">Idade</label>
                    <input type="number" id="add_idade" name="idade" readonly class="rounded-md bg-gray-200 cursor-not-allowed">
                </div>
                <div class="form-group">
                    <label for="add_id_turma">Turma</label>
                    <select id="add_id_turma" name="id_turma" class="rounded-md">
                        <option value="">Selecione a Turma</option>
                        <!-- Turmas serão carregadas aqui via JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="add_periodo">Período</label>
                    <select id="add_periodo" name="periodo" class="rounded-md">
                        <option value="">Selecione</option>
                        <option value="Manhã">Manhã</option>
                        <option value="Tarde">Tarde</option>
                        <option value="Noite">Noite</option>
                    </select>
                </div>
                
                <h3 class="text-xl font-semibold text-gray-700 md:col-span-2 mt-4">Informações de Endereço</h3>
                <div class="form-group">
                    <label for="add_cep">CEP</label>
                    <input type="text" id="add_cep" name="cep" class="rounded-md" maxlength="9" placeholder="Ex: 12345-678">
                </div>
                <div class="form-group">
                    <label for="add_endereco">Endereço</label>
                    <input type="text" id="add_endereco" name="endereco" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="add_complemento">Complemento</label>
                    <input type="text" id="add_complemento" name="complemento" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="add_bairro">Bairro</label>
                    <input type="text" id="add_bairro" name="bairro" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="add_cidade">Cidade</label>
                    <input type="text" id="add_cidade" name="cidade" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="add_estado">Estado (UF)</label>
                    <input type="text" id="add_estado" name="estado" maxlength="2" class="rounded-md">
                </div>
                
                <h3 class="text-xl font-semibold text-gray-700 md:col-span-2 mt-4">Informações do Responsável</h3>
                <div class="form-group">
                    <label for="add_responsavel">Nome do Responsável</label>
                    <input type="text" id="add_responsavel" name="responsavel" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="add_telefone_responsavel">Telefone do Responsável</label>
                    <input type="text" id="add_telefone_responsavel" name="telefone_responsavel" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="add_celular_responsavel">Celular do Responsável</label>
                    <input type="text" id="add_celular_responsavel" name="celular_responsavel" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="add_email_responsavel">Email do Responsável</label>
                    <input type="email" id="add_email_responsavel" name="email_responsavel" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="add_cpf_responsavel">CPF do Responsável</label>
                    <input type="text" id="add_cpf_responsavel" name="cpf_responsavel" class="rounded-md">
                </div>

                <div class="md:col-span-2 mt-4 flex items-center">
                    <h3 class="text-xl font-semibold text-gray-700">Informações do Pai</h3>
                    <button type="button" class="btn btn-copy" onclick="copyResponsibleInfo('father', 'add_')">
                        Copiar do Responsável
                    </button>
                    <span class="text-red-500 ml-2">* (Pelo menos um par Nome/CPF é obrigatório)</span>
                </div>
                <div class="form-group">
                    <label for="add_nome_pai">Nome do Pai</label>
                    <input type="text" id="add_nome_pai" name="nome_pai" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="add_cpf_pai">CPF do Pai</label>
                    <input type="text" id="add_cpf_pai" name="cpf_pai" class="rounded-md">
                </div>

                <div class="md:col-span-2 mt-4 flex items-center">
                    <h3 class="text-xl font-semibold text-gray-700">Informações da Mãe</h3>
                    <button type="button" class="btn btn-copy" onclick="copyResponsibleInfo('mother', 'add_')">
                        Copiar do Responsável
                    </button>
                </div>
                <div class="form-group">
                    <label for="add_nome_mae">Nome da Mãe</label>
                    <input type="text" id="add_nome_mae" name="nome_mae" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="add_cpf_mae">CPF da Mãe</label>
                    <input type="text" id="add_cpf_mae" name="cpf_mae" class="rounded-md">
                </div>

                <div class="md:col-span-2 flex justify-end space-x-4 mt-6">
                    <button type="submit" class="btn btn-primary">Adicionar Aluno</button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddAlunoModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edição de Aluno -->
    <div id="editAlunoModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4" id="edit-form-title">Editar Aluno</h2>
            <!-- Área de mensagem específica para o modal de edição -->
            <div id="edit-message-area" class="message hidden"></div>
            <form id="edit-aluno-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="edit_aluno_id">

                <div class="form-group">
                    <label for="edit_nome_aluno">Nome do Aluno <span class="text-red-500">*</span></label>
                    <input type="text" id="edit_nome_aluno" name="nome_aluno" required class="rounded-md">
                    <span id="edit_nome_aluno_error" class="error-message hidden"></span>
                </div>
                <div class="form-group">
                    <label for="edit_ra">RA <span class="text-red-500">*</span></label>
                    <input type="text" id="edit_ra" name="ra" required class="rounded-md">
                    <span id="edit_ra_error" class="error-message hidden"></span>
                </div>
                <div class="form-group">
                    <label for="edit_data_nascimento">Data de Nascimento</label>
                    <input type="date" id="edit_data_nascimento" name="data_nascimento" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="edit_idade">Idade</label>
                    <input type="number" id="edit_idade" name="idade" readonly class="rounded-md bg-gray-200 cursor-not-allowed">
                </div>
                <div class="form-group">
                    <label for="edit_id_turma">Turma</label>
                    <select id="edit_id_turma" name="id_turma" class="rounded-md">
                        <option value="">Selecione a Turma</option>
                        <!-- Turmas serão carregadas aqui via JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit_periodo">Período</label>
                    <select id="edit_periodo" name="periodo" class="rounded-md">
                        <option value="">Selecione</option>
                        <option value="Manhã">Manhã</option>
                        <option value="Tarde">Tarde</option>
                        <option value="Noite">Noite</option>
                    </select>
                </div>
                
                <h3 class="text-xl font-semibold text-gray-700 md:col-span-2 mt-4">Informações de Endereço</h3>
                <div class="form-group">
                    <label for="edit_cep">CEP</label>
                    <input type="text" id="edit_cep" name="cep" class="rounded-md" maxlength="9" placeholder="Ex: 12345-678">
                </div>
                <div class="form-group">
                    <label for="edit_endereco">Endereço</label>
                    <input type="text" id="edit_endereco" name="endereco" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="edit_complemento">Complemento</label>
                    <input type="text" id="edit_complemento" name="complemento" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="edit_bairro">Bairro</label>
                    <input type="text" id="edit_bairro" name="bairro" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="edit_cidade">Cidade</label>
                    <input type="text" id="edit_cidade" name="cidade" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="edit_estado">Estado (UF)</label>
                    <input type="text" id="edit_estado" name="estado" maxlength="2" class="rounded-md">
                </div>
                
                <h3 class="text-xl font-semibold text-gray-700 md:col-span-2 mt-4">Informações do Responsável</h3>
                <div class="form-group">
                    <label for="edit_responsavel">Nome do Responsável</label>
                    <input type="text" id="edit_responsavel" name="responsavel" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="edit_telefone_responsavel">Telefone do Responsável</label>
                    <input type="text" id="edit_telefone_responsavel" name="telefone_responsavel" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="edit_celular_responsavel">Celular do Responsável</label>
                    <input type="text" id="edit_celular_responsavel" name="celular_responsavel" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="edit_email_responsavel">Email do Responsável</label>
                    <input type="email" id="edit_email_responsavel" name="email_responsavel" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="edit_cpf_responsavel">CPF do Responsável</label>
                    <input type="text" id="edit_cpf_responsavel" name="cpf_responsavel" class="rounded-md">
                </div>

                <div class="md:col-span-2 mt-4 flex items-center">
                    <h3 class="text-xl font-semibold text-gray-700">Informações do Pai</h3>
                    <button type="button" class="btn btn-copy" onclick="copyResponsibleInfo('father', 'edit_')">
                        Copiar do Responsável
                    </button>
                    <span class="text-red-500 ml-2">* (Pelo menos um par Nome/CPF é obrigatório)</span>
                </div>
                <div class="form-group">
                    <label for="edit_nome_pai">Nome do Pai</label>
                    <input type="text" id="edit_nome_pai" name="nome_pai" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="edit_cpf_pai">CPF do Pai</label>
                    <input type="text" id="edit_cpf_pai" name="cpf_pai" class="rounded-md">
                </div>

                <div class="md:col-span-2 mt-4 flex items-center">
                    <h3 class="text-xl font-semibold text-gray-700">Informações da Mãe</h3>
                    <button type="button" class="btn btn-copy" onclick="copyResponsibleInfo('mother', 'edit_')">
                        Copiar do Responsável
                    </button>
                </div>
                <div class="form-group">
                    <label for="edit_nome_mae">Nome da Mãe</label>
                    <input type="text" id="edit_nome_mae" name="nome_mae" class="rounded-md">
                </div>
                <div class="form-group">
                    <label for="edit_cpf_mae">CPF da Mãe</label>
                    <input type="text" id="edit_cpf_mae" name="cpf_mae" class="rounded-md">
                </div>

                <div class="md:col-span-2 flex justify-end space-x-4 mt-6">
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuração da URL base da sua API
        const API_BASE_URL_ALUNOS = 'http://localhost/Sistema/api/alunos'; 
        const API_BASE_URL_TURMAS = 'http://localhost/Sistema/api/turmas'; 
        // URLs das páginas HTML, relativas à pasta 'public'
        const API_LOGIN_URL = 'login.html'; 
        const ALUNO_DASHBOARD_URL = 'aluno_dashboard.html';
        const CRUD_ALUNOS_URL = 'crud_alunos.html';
        const CRUD_TURMAS_URL = 'crud_turmas.html';

        // Elementos do formulário de ADIÇÃO (agora no modal)
        const addAlunoModal = document.getElementById('addAlunoModal');
        const addAlunoForm = document.getElementById('add-aluno-form');
        const addDataNascimentoInput = document.getElementById('add_data_nascimento');
        const addIdadeInput = document.getElementById('add_idade');
        const addCepInput = document.getElementById('add_cep');
        const addEnderecoInput = document.getElementById('add_endereco');
        const addBairroInput = document.getElementById('add_bairro');
        const addCidadeInput = document.getElementById('add_cidade');
        const addEstadoInput = document.getElementById('add_estado');
        const addIdTurmaSelect = document.getElementById('add_id_turma');
        const addNomeAlunoError = document.getElementById('add_nome_aluno_error');
        const addRaError = document.getElementById('add_ra_error');
        const addMessageArea = document.getElementById('add-message-area'); // Área de mensagem específica do modal de adição


        // Elementos do MODAL de EDIÇÃO
        const editAlunoModal = document.getElementById('editAlunoModal');
        const editAlunoForm = document.getElementById('edit-aluno-form');
        const editAlunoIdInput = document.getElementById('edit_aluno_id');
        const editFormTitle = document.getElementById('edit-form-title');
        const editDataNascimentoInput = document.getElementById('edit_data_nascimento');
        const editIdadeInput = document.getElementById('edit_idade');
        const editCepInput = document.getElementById('edit_cep');
        const editEnderecoInput = document.getElementById('edit_endereco');
        const editBairroInput = document.getElementById('edit_bairro');
        const editCidadeInput = document.getElementById('edit_cidade');
        const editEstadoInput = document.getElementById('edit_estado');
        const editIdTurmaSelect = document.getElementById('edit_id_turma');
        const editNomeAlunoError = document.getElementById('edit_nome_aluno_error');
        const editRaError = document.getElementById('edit_ra_error');
        const editMessageArea = document.getElementById('edit-message-area'); // Área de mensagem específica do modal de edição


        const alunosTableBody = document.getElementById('alunos-table-body');
        const messageArea = document.getElementById('message-area'); // Área de mensagem geral da página

        let turmas = []; // Array para armazenar as turmas carregadas

        // Função para limpar números (remover caracteres não numéricos)
        function cleanNumber(number) {
            return number ? String(number).replace(/\D/g, '') : null;
        }

        // Exibe mensagens de sucesso ou erro (geral ou específica de modal)
        function displayMessage(message, type, targetArea = messageArea) {
            targetArea.textContent = message;
            targetArea.className = `message ${type}`;
            targetArea.classList.remove('hidden');
            setTimeout(() => {
                targetArea.classList.add('hidden');
            }, 5000); // Esconde a mensagem após 5 segundos
        }

        // Exibe mensagem de erro para um campo específico
        function displayFieldError(errorSpanElement, message) {
            errorSpanElement.textContent = message;
            errorSpanElement.classList.remove('hidden');
        }

        // Limpa todas as mensagens de erro de campo
        function clearFieldErrors(prefix) {
            document.getElementById(`${prefix}nome_aluno_error`).classList.add('hidden');
            document.getElementById(`${prefix}ra_error`).classList.add('hidden');
            // Limpa a mensagem geral do modal também
            document.getElementById(`${prefix}message-area`).classList.add('hidden');
        }

        // Limpa o formulário de ADIÇÃO e fecha o modal
        function clearAddForm() {
            addAlunoForm.reset();
            addIdadeInput.value = ''; 
            addIdTurmaSelect.value = ''; 
            clearFieldErrors('add_'); // Limpa erros de campo
            addMessageArea.classList.add('hidden'); // Esconde a mensagem geral do modal
            closeAddAlunoModal(); 
        }

        // Abre o modal de adição de Aluno
        function openAddAlunoModal() {
            console.log('Abrindo modal de adição de aluno'); 
            if (addAlunoModal) {
                addAlunoModal.classList.remove('hidden');
                addAlunoModal.classList.add('visible');
                addAlunoForm.reset(); 
                addIdadeInput.value = ''; // Garante que a idade esteja limpa
                addIdTurmaSelect.value = ''; // Garante que o select esteja resetado
                clearFieldErrors('add_'); // Limpa erros de campo ao abrir
                addMessageArea.classList.add('hidden'); // Esconde a mensagem geral do modal
                fetchTurmas(); 
            } else {
                console.error('Erro: Elemento addAlunoModal não encontrado.');
            }
        }

        // Fecha o modal de adição de Aluno
        function closeAddAlunoModal() {
            if (addAlunoModal) {
                addAlunoModal.classList.remove('visible');
                addAlunoModal.classList.add('hidden');
                // Não reseta o formulário aqui, pois clearAddForm já faz isso e é chamado antes
            }
        }

        // Abre o modal de edição de Aluno
        function openEditModal() {
            if (editAlunoModal) {
                editAlunoModal.classList.remove('hidden');
                editAlunoModal.classList.add('visible');
                clearFieldErrors('edit_'); // Limpa erros de campo ao abrir
                editMessageArea.classList.add('hidden'); // Esconde a mensagem geral do modal
                fetchTurmas(); // Recarrega as turmas para o select de edição
            } else {
                console.error('Erro: Elemento editAlunoModal não encontrado.');
            }
        }

        // Fecha o modal de edição de Aluno
        function closeEditModal() {
            if (editAlunoModal) {
                editAlunoModal.classList.remove('visible');
                editAlunoModal.classList.add('hidden');
                editAlunoForm.reset(); 
                editAlunoIdInput.value = ''; 
                editIdadeInput.value = ''; 
                editIdTurmaSelect.value = ''; 
                clearFieldErrors('edit_'); // Limpa erros de campo
                editMessageArea.classList.add('hidden'); // Esconde a mensagem geral do modal
            }
        }

        // Função para calcular a idade a partir da data de nascimento
        function calculateAge(dateInput, ageInput) {
            const birthDate = new Date(dateInput.value);
            if (isNaN(birthDate)) { 
                ageInput.value = '';
                return;
            }
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            ageInput.value = age;
        }

        // Adiciona event listeners para calcular a idade nos dois formulários
        addDataNascimentoInput.addEventListener('change', () => calculateAge(addDataNascimentoInput, addIdadeInput));
        editDataNascimentoInput.addEventListener('change', () => calculateAge(editDataNascimentoInput, editIdadeInput));


        // Função para preencher endereço a partir do CEP
        async function fillAddressByCep(cepInputElem, enderecoInputElem, bairroInputElem, cidadeInputElem, estadoInputElem, targetMessageArea) {
            let cep = cleanNumber(cepInputElem.value);

            if (cep.length !== 8) {
                enderecoInputElem.value = '';
                bairroInputElem.value = '';
                cidadeInputElem.value = '';
                estadoInputElem.value = '';
                return;
            }

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();

                if (!data.erro) {
                    enderecoInputElem.value = data.logradouro || '';
                    bairroInputElem.value = data.bairro || '';
                    cidadeInputElem.value = data.localidade || '';
                    estadoInputElem.value = data.uf || '';
                } else {
                    displayMessage('CEP não encontrado.', 'error', targetMessageArea);
                    enderecoInputElem.value = '';
                    bairroInputElem.value = '';
                    cidadeInputElem.value = '';
                    estadoInputElem.value = '';
                }
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
                displayMessage('Erro ao consultar o serviço de CEP.', 'error', targetMessageArea);
                enderecoInputElem.value = '';
                bairroInputElem.value = '';
                cidadeInputElem.value = '';
                estadoInputElem.value = '';
            }
        }

        // Adiciona event listeners para preencher o endereço pelo CEP nos dois formulários
        addCepInput.addEventListener('blur', () => fillAddressByCep(addCepInput, addEnderecoInput, addBairroInput, addCidadeInput, addEstadoInput, addMessageArea));
        addCepInput.addEventListener('input', () => { 
            if (cleanNumber(addCepInput.value).length < 8) {
                addEnderecoInput.value = '';
                addBairroInput.value = '';
                addCidadeInput.value = '';
                addEstadoInput.value = '';
            }
        });
        editCepInput.addEventListener('blur', () => fillAddressByCep(editCepInput, editEnderecoInput, editBairroInput, editCidadeInput, editEstadoInput, editMessageArea));
        editCepInput.addEventListener('input', () => { 
            if (cleanNumber(editCepInput.value).length < 8) {
                editEnderecoInput.value = '';
                editBairroInput.value = '';
                editCidadeInput.value = '';
                editEstadoInput.value = '';
            }
        });


        // Função para copiar dados do responsável para pai ou mãe
        function copyResponsibleInfo(target, prefix) {
            const responsavelName = document.getElementById(`${prefix}responsavel`).value;
            const responsavelCpf = document.getElementById(`${prefix}cpf_responsavel`).value;

            if (target === 'father') {
                document.getElementById(`${prefix}nome_pai`).value = responsavelName;
                document.getElementById(`${prefix}cpf_pai`).value = responsavelCpf;
            } else if (target === 'mother') {
                document.getElementById(`${prefix}nome_mae`).value = responsavelName;
                document.getElementById(`${prefix}cpf_mae`).value = responsavelCpf;
            }
        }

        // Função para formatar data para senha (DDMMYYYY)
        function formatBirthDateForPassword(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00'); // Adiciona T00:00:00 para evitar problemas de fuso horário
            if (isNaN(date)) return '';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}${month}${year}`;
        }

        // Função para alternar visibilidade da senha
        function togglePasswordVisibility(buttonElement, passwordText) {
            const passwordSpan = buttonElement.previousElementSibling; 
            if (passwordSpan.textContent.includes('********')) {
                passwordSpan.textContent = passwordText;
                buttonElement.innerHTML = '&#128065;'; // Ícone de olho aberto
            } else {
                passwordSpan.textContent = '********';
                buttonElement.innerHTML = '&#128064;'; // Ícone de olho fechado
            }
        }

        // Função para carregar as turmas e preencher os selects
        async function fetchTurmas() {
            try {
                const response = await fetch(API_BASE_URL_TURMAS, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
                    }
                });
                if (response.status === 401 || response.status === 403) {
                    window.location.href = API_LOGIN_URL;
                    return; 
                }

                const data = await response.json();

                if (data.success) {
                    turmas = data.data; 
                    addIdTurmaSelect.innerHTML = '<option value="">Selecione a Turma</option>'; 
                    turmas.forEach(turma => {
                        const option = document.createElement('option');
                        option.value = turma.id_turma;
                        option.textContent = turma.nome_turma;
                        addIdTurmaSelect.appendChild(option);
                    });
                    editIdTurmaSelect.innerHTML = '<option value="">Selecione a Turma</option>'; 
                    turmas.forEach(turma => {
                        const option = document.createElement('option');
                        option.value = turma.id_turma;
                        option.textContent = turma.nome_turma;
                        editIdTurmaSelect.appendChild(option);
                    });
                } else {
                    displayMessage(`Erro ao carregar turmas: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao buscar turmas:', error);
                displayMessage('Erro de conexão ao buscar turmas.', 'error');
            }
        }


        // Carrega todos os alunos e preenche a tabela
        async function fetchAlunos() {
            try {
                const response = await fetch(API_BASE_URL_ALUNOS, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
                    }
                });
                if (response.status === 401 || response.status === 403) {
                    window.location.href = API_LOGIN_URL;
                    return; 
                }

                const data = await response.json();

                if (data.success) {
                    alunosTableBody.innerHTML = ''; 
                    data.data.forEach(aluno => {
                        const alunoLogin = aluno.ra || ''; 
                        const alunoPassword = formatBirthDateForPassword(aluno.data_nascimento); 

                        const row = `
                            <tr>
                                <td>${aluno.id_aluno}</td>
                                <td>${aluno.nome_aluno}</td>
                                <td>${aluno.ra}</td>
                                <td>${aluno.idade || ''}</td>
                                <td>${aluno.nome_turma || ''}</td>
                                <td>${aluno.periodo || ''}</td>
                                <td>${aluno.endereco || ''}</td>
                                <td>${aluno.complemento || ''}</td>
                                <td>${aluno.bairro || ''}</td>
                                <td>${aluno.cidade || ''}</td>
                                <td>${aluno.estado || ''}</td> 
                                <td>${aluno.cep || ''}</td>
                                <td>${aluno.responsavel || ''}</td>
                                <td>${aluno.telefone_responsavel || ''}</td>
                                <td>${aluno.celular_responsavel || ''}</td>
                                <td>${aluno.email_responsavel || ''}</td>
                                <td>${aluno.cpf_responsavel || ''}</td>
                                <td>${aluno.nome_pai || ''}</td>
                                <td>${aluno.cpf_pai || ''}</td>
                                <td>${aluno.nome_mae || ''}</td>
                                <td>${aluno.cpf_mae || ''}</td>
                                <td>${alunoLogin}</td> 
                                <td>
                                    <span id="password-${aluno.id_aluno}">********</span> 
                                    <button class="ml-2 text-blue-500 hover:text-blue-700" 
                                            onclick="togglePasswordVisibility(this, '${alunoPassword}')"
                                            title="Mostrar/Esconder Senha">
                                        &#128064; 
                                    </button>
                                </td>
                                <td class="whitespace-nowrap">
                                    <button class="btn btn-edit text-sm mr-2" onclick="editAluno(${aluno.id_aluno})">Editar</button>
                                    <button class="btn btn-delete text-sm" onclick="deleteAluno(${aluno.id_aluno})">Excluir</button>
                                </td>
                            </tr>
                        `;
                        alunosTableBody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    displayMessage(`Erro ao carregar alunos: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao buscar alunos:', error);
                displayMessage('Erro de conexão ao buscar alunos.', 'error');
            }
        }

        // Preenche o formulário do MODAL para edição
        async function editAluno(id) {
            try {
                const response = await fetch(`${API_BASE_URL_ALUNOS}/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
                    }
                });
                if (response.status === 401 || response.status === 403) {
                    window.location.href = API_LOGIN_URL;
                    return; 
                }

                const data = await response.json();

                if (data.success) {
                    const aluno = data.data;
                    editAlunoIdInput.value = aluno.id_aluno;
                    document.getElementById('edit_nome_aluno').value = aluno.nome_aluno;
                    document.getElementById('edit_ra').value = aluno.ra;
                    document.getElementById('edit_data_nascimento').value = aluno.data_nascimento || '';
                    document.getElementById('edit_idade').value = aluno.idade || ''; 
                    editIdTurmaSelect.value = aluno.id_turma || ''; 
                    document.getElementById('edit_periodo').value = aluno.periodo || '';
                    
                    document.getElementById('edit_cep').value = aluno.cep || '';
                    document.getElementById('edit_endereco').value = aluno.endereco || '';
                    document.getElementById('edit_complemento').value = aluno.complemento || '';
                    document.getElementById('edit_bairro').value = aluno.bairro || '';
                    document.getElementById('edit_cidade').value = aluno.cidade || '';
                    document.getElementById('edit_estado').value = aluno.estado || ''; 

                    document.getElementById('edit_responsavel').value = aluno.responsavel || '';
                    document.getElementById('edit_telefone_responsavel').value = aluno.telefone_responsavel || '';
                    document.getElementById('edit_celular_responsavel').value = aluno.celular_responsavel || '';
                    document.getElementById('edit_email_responsavel').value = aluno.email_responsavel || '';
                    document.getElementById('edit_cpf_responsavel').value = aluno.cpf_responsavel || '';
                    document.getElementById('edit_nome_pai').value = aluno.nome_pai || '';
                    document.getElementById('edit_cpf_pai').value = aluno.cpf_pai || '';
                    document.getElementById('edit_nome_mae').value = aluno.nome_mae || '';
                    document.getElementById('edit_cpf_mae').value = aluno.cpf_mae || '';

                    editFormTitle.textContent = `Editar Aluno (ID: ${aluno.id_aluno})`;
                    openEditModal(); 
                } else {
                    displayMessage(`Erro ao carregar aluno para edição: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao buscar aluno para edição:', error);
                displayMessage('Erro de conexão ao buscar aluno para edição.', 'error');
            }
        }

        // Envia o formulário de ADIÇÃO
        addAlunoForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            clearFieldErrors('add_'); // Limpa erros anteriores

            const formData = new FormData(addAlunoForm);
            const alunoData = {};
            for (let [key, value] of formData.entries()) {
                if (key.includes('cpf') || key.includes('telefone') || key.includes('celular')) {
                    alunoData[key] = cleanNumber(value);
                } else {
                    alunoData[key] = value === '' ? null : value; 
                }
            }
            
            // Validação de campos obrigatórios no frontend
            let isValid = true;
            if (!alunoData.nome_aluno) {
                displayFieldError(addNomeAlunoError, 'Nome do Aluno é obrigatório.');
                isValid = false;
            }
            if (!alunoData.ra) {
                displayFieldError(addRaError, 'RA é obrigatório.');
                isValid = false;
            }
            const hasFatherInfo = !!alunoData.nome_pai && !!alunoData.cpf_pai;
            const hasMotherInfo = !!alunoData.nome_mae && !!alunoData.cpf_mae;
            if (!hasFatherInfo && !hasMotherInfo) {
                displayMessage('Pelo menos o nome e CPF do pai OU da mãe devem ser fornecidos.', 'error', addMessageArea);
                isValid = false;
            }

            if (!isValid) {
                return; // Impede o envio se a validação falhar
            }

            alunoData.id_turma = alunoData.id_turma ? parseInt(alunoData.id_turma) : null;


            try {
                const response = await fetch(API_BASE_URL_ALUNOS, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
                    },
                    body: JSON.stringify(alunoData)
                });
                if (response.status === 401 || response.status === 403) {
                    window.location.href = API_LOGIN_URL;
                    return; 
                }

                const data = await response.json();

                if (data.success) {
                    displayMessage(data.message, 'success', addMessageArea); // Exibe mensagem no modal
                    clearAddForm(); 
                    fetchAlunos(); 
                } else {
                    // Exibe mensagem de erro da API (ex: RA já existe) no modal
                    displayMessage(data.message, 'error', addMessageArea); 
                }
            } catch (error) {
                console.error('Erro ao adicionar aluno:', error);
                displayMessage('Erro de conexão ao adicionar aluno.', 'error', addMessageArea);
            }
        });

        // Envia o formulário do MODAL (EDIÇÃO)
        editAlunoForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            clearFieldErrors('edit_'); // Limpa erros anteriores

            const id = editAlunoIdInput.value;
            const method = 'PUT';
            const url = `${API_BASE_URL_ALUNOS}/${id}`;

            const formData = new FormData(editAlunoForm);
            const alunoData = {};
            for (let [key, value] of formData.entries()) {
                if (key.includes('cpf') || key.includes('telefone') || key.includes('celular')) {
                    alunoData[key] = cleanNumber(value);
                } else {
                    alunoData[key] = value === '' ? null : value; 
                }
            }
            
            // Validação de campos obrigatórios no frontend
            let isValid = true;
            if (!alunoData.nome_aluno) {
                displayFieldError(editNomeAlunoError, 'Nome do Aluno é obrigatório.');
                isValid = false;
            }
            if (!alunoData.ra) {
                displayFieldError(editRaError, 'RA é obrigatório.');
                isValid = false;
            }
            const hasFatherInfo = !!alunoData.nome_pai && !!alunoData.cpf_pai;
            const hasMotherInfo = !!alunoData.nome_mae && !!alunoData.cpf_mae;
            if (!hasFatherInfo && !hasMotherInfo) {
                displayMessage('Pelo menos o nome e CPF do pai OU da mãe devem ser fornecidos.', 'error', editMessageArea);
                isValid = false;
            }

            if (!isValid) {
                return; // Impede o envio se a validação falhar
            }

            alunoData.id_turma = alunoData.id_turma ? parseInt(alunoData.id_turma) : null;


            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
                    },
                    body: JSON.stringify(alunoData)
                });
                if (response.status === 401 || response.status === 403) {
                    window.location.href = API_LOGIN_URL;
                    return; 
                }

                const data = await response.json();

                if (data.success) {
                    displayMessage(data.message, 'success', editMessageArea); // Exibe mensagem no modal
                    closeEditModal(); 
                    fetchAlunos(); 
                } else {
                    // Exibe mensagem de erro da API (ex: RA já existe) no modal
                    displayMessage(data.message, 'error', editMessageArea); 
                }
            } catch (error) {
                console.error('Erro ao salvar aluno:', error);
                displayMessage('Erro de conexão ao salvar aluno.', 'error', editMessageArea);
            }
        });


        // Deleta um aluno
        async function deleteAluno(id) {
            if (!confirm('Tem certeza que deseja excluir este aluno?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL_ALUNOS}/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
                    }
                });
                if (response.status === 401 || response.status === 403) {
                    window.location.href = API_LOGIN_URL;
                    return; 
                }

                const data = await response.json();

                if (data.success) {
                    displayMessage(data.message, 'success');
                    fetchAlunos(); 
                } else {
                    displayMessage(data.message, 'error');
                }
            } catch (error) {
                console.error('Erro ao deletar aluno:', error);
                displayMessage('Erro de conexão ao deletar aluno.', 'error');
            }
        }

        // Função de Logout
        function logout() {
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_role');
            window.location.href = API_LOGIN_URL;
        }

        // Verificação de autenticação ao carregar a página
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('jwt_token');
            const role = localStorage.getItem('user_role');

            if (!token || (role !== 'professor' && role !== 'admin')) {
                window.location.href = API_LOGIN_URL;
                return;
            }

            await fetchTurmas(); 
            fetchAlunos(); 
        });
    </script>
</body>
</html>
