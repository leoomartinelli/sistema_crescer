<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard do Professor - Sistema Crescer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/loader.css">
    <script src="js/loader.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
        .btn-action { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease-in-out; }
        .btn-manage { background-color: #3b82f6; color: #ffffff; }
        .btn-manage:hover { background-color: #2563eb; }
    </style>
</head>
<body>
    <nav class="bg-gray-800 p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center max-w-5xl">
            <a href="#" class="text-white text-2xl font-bold">Sistema Crescer</a>
            <div>
                <button onclick="logout()" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-base font-medium">Sair</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-6 max-w-5xl">
        <header class="mb-8">
            <h1 id="welcome-message" class="text-3xl md:text-4xl font-bold text-gray-800">Carregando...</h1>
            <p id="professor-info" class="text-lg text-gray-600 mt-1"></p>
        </header>
        
        <section id="turmas-section" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 mt-12 border-b pb-2">Minhas Turmas</h2>
            <div class="card overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Nome da Turma</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Início Lecionar</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Fim Lecionar</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-turmas-professor" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                <p id="no-turmas-message" class="text-center p-4 text-gray-500 hidden">Você não está associado a nenhuma turma no momento.</p>
            </div>
        </section>

        <div id="loading-message" class="text-center text-gray-500 mt-8">Carregando...</div>
        <div id="error-message" class="hidden mt-8 p-4 bg-red-100 text-red-700 rounded-lg"></div>
    </main>


    <div id="global-loader" class="loader-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost/Sistema/api';
        const API_LOGIN_URL = 'login.html';


        window.showLoader = function () {
            const loader = document.getElementById('global-loader');
            if (loader) {
                loader.style.display = 'flex';
            }
        }

        window.hideLoader = function () {
            const loader = document.getElementById('global-loader');
            if (loader) {
                loader.style.display = 'none';
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = API_LOGIN_URL;
        }

        const formatDate = (d) => d ? new Date(d).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : '--/--/----';
        const formatCpf = (cpf) => {
            if (!cpf) return '';
            const cleaned = String(cpf).replace(/\D/g, '');
            if (cleaned.length === 11) {
                return cleaned.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            }
            return cleaned;
        };

        document.addEventListener('DOMContentLoaded', async () => {
            showLoader();
            const token = localStorage.getItem('jwt_token');
            const role = localStorage.getItem('user_role');

            if (!token || (role !== 'professor' && role !== 'admin')) {
                logout();
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/professor/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Falha ao carregar dados do professor.");
                }

                const result = await response.json();

                if (result.success) {
                    const professor = result.data.professor;
                    const turmas = result.data.turmas;

                    document.getElementById('welcome-message').textContent = `Bem-vindo(a), Prof. ${professor.nome_professor}!`;
                    document.getElementById('professor-info').textContent = `CPF: ${formatCpf(professor.cpf)} | Email: ${professor.email || 'N/A'}`;

                    renderTurmas(turmas);
                    document.getElementById('turmas-section').classList.remove('hidden');
                } else {
                    document.getElementById('error-message').textContent = result.message;
                    document.getElementById('error-message').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro no carregamento do dashboard do professor:", error);
                document.getElementById('error-message').textContent = `Erro ao carregar dados: ${error.message}. Tente novamente.`;
                document.getElementById('error-message').classList.remove('hidden');
            } finally {
                document.getElementById('loading-message').classList.add('hidden');
                hideLoader();
            }
        });

        function renderTurmas(turmas) {
            const tabelaBody = document.getElementById('tabela-turmas-professor');
            tabelaBody.innerHTML = '';

            if (turmas.length > 0) {
                turmas.forEach(t => {
                    const row = `
                        <tr>
                            <td class="px-6 py-4 font-medium">${t.nome_turma}</td>
                            <td class="px-6 py-4">${formatDate(t.data_inicio_lecionar)}</td>
                            <td class="px-6 py-4">${formatDate(t.data_fim_lecionar)}</td>
                            <td class="px-6 py-4 text-center">
                                <a href="gerenciar_boletim.html?idTurma=${t.id_turma}&nomeTurma=${encodeURIComponent(t.nome_turma)}" class="btn-action btn-manage text-sm">Gerenciar Boletim</a>
                            </td>
                        </tr>
                    `;
                    tabelaBody.innerHTML += row;
                });
            } else {
                document.getElementById('no-turmas-message').classList.remove('hidden');
            }
        }
    </script>
</body>
</html>