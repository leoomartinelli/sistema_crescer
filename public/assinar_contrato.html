<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assinatura de Contrato - Sistema Crescer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div id="main-content" class="w-full max-w-4xl bg-white p-8 rounded-lg shadow-lg hidden">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Assinatura de Contrato Pendente</h1>
        <p class="text-gray-600 mb-6">Para continuar, você deve assinar este contrato digitalmente usando a plataforma GOV.br.</p>

        <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 mb-6">
            <h3 class="font-semibold text-xl mb-2">Passo a Passo:</h3>
            <ol class="list-decimal list-inside space-y-2">
                <li><strong>Baixe o Contrato:</strong> Clique no link abaixo para baixar o PDF.</li>
                <li><strong>Assine no GOV.br:</strong> Acesse <a href="https://assinador.iti.br/" target="_blank" class="text-blue-600 underline hover:text-blue-800">assinador.iti.br</a> e assine o arquivo baixado.</li>
                <li><strong>Envie o Contrato Assinado:</strong> Use o campo abaixo para enviar o arquivo PDF já assinado.</li>
            </ol>
        </div>

        <div class="w-full h-[60vh] border rounded-md mb-6">
            <iframe id="contract-pdf" src="" class="w-full h-full"></iframe>
        </div>

        <a id="download-contract-link" href="#" class="inline-block bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors mb-6">
            Baixar Contrato
        </a>

        <form id="upload-form" class="space-y-4">
            <div>
                <label for="signed-pdf-upload" class="block text-md font-medium text-gray-700">Enviar Contrato Assinado</label>
                <input type="file" id="signed-pdf-upload" name="signed_pdf" accept="application/pdf" required class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50">
            </div>
            <button type="submit" id="upload-button" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">
                Enviar e Finalizar
            </button>
        </form>
    </div>

    <div id="loading-message" class="text-center">
        <p class="text-lg text-gray-600">Carregando informações do contrato...</p>
    </div>

   <script>
    const API_BASE_URL = 'http://localhost/Sistema/api';

    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('jwt_temporary');
        const contractId = localStorage.getItem('contract_id');
        const contractPath = localStorage.getItem('contract_path');

        if (!token || !contractId || !contractPath) {
            Swal.fire({
                icon: 'error',
                title: 'Erro!',
                text: 'Informações de contrato inválidas. Por favor, faça o login novamente.'
            }).then(() => {
                localStorage.clear();
                window.location.href = 'login.html';
            });
            return;
        }

        document.getElementById('loading-message').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');

        document.getElementById('contract-pdf').src = `http://localhost/Sistema/${contractPath}`;
        const downloadLink = document.getElementById('download-contract-link');
        downloadLink.href = `http://localhost/Sistema/${contractPath}`;
        downloadLink.setAttribute('download', 'Contrato.pdf');

        const uploadForm = document.getElementById('upload-form');
        const uploadButton = document.getElementById('upload-button');
        
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            uploadButton.disabled = true;
            uploadButton.textContent = 'Enviando...';

            const formData = new FormData(uploadForm);
            formData.append('contract_id', contractId);

            try {
                const response = await fetch(`${API_BASE_URL}/contratos/uploadAssinado`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    localStorage.removeItem('jwt_temporary');
                    localStorage.removeItem('contract_id');
                    localStorage.removeItem('contract_path');
                    uploadForm.classList.add('hidden');
                    downloadLink.classList.add('hidden');

                    // 2. A antiga função displayMessage() foi substituída pela chamada ao SweetAlert2
                    Swal.fire({
                        icon: 'success',
                        title: 'Tudo Certo!',
                        text: 'Seu contrato foi recebido com sucesso! A secretaria fará a análise e, assim que for validado, seu acesso ao portal será liberado.',
                        confirmButtonText: 'Ok'
                    });

                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: result.message || 'Ocorreu um erro ao enviar o contrato.',
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro de Conexão',
                    text: 'Não foi possível conectar ao servidor. Verifique sua internet e tente novamente.',
                });
            } finally {
                // Apenas reabilita o botão se houver falha na resposta
                if (!response.ok) {
                    uploadButton.disabled = false;
                    uploadButton.textContent = 'Enviar e Finalizar';
                }
            }
        });
    });
</script>
</body>
</html>